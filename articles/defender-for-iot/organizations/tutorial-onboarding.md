---
title: Microsoft Defender for IoT trial setup
description: In this tutorial, you will learn how to onboard to Microsoft Defender for IoT with a virtual sensor, on a virtual machine, with a trial subscription of Microsoft Defender for IoT.
author: ElazarK
ms.author: v-ekrieg
ms.topic: tutorial
ms.date: 11/09/2021
ms.custom: template-tutorial
---

# Tutorial: Microsoft Defender for IoT trial setup

This tutorial will help you learn how to onboard to Microsoft Defender for IoT with a virtual sensor, on a virtual machine, with a trial subscription of Microsoft Defender for IoT. This tutorial will show you the optimal setup for someone who wishes to test Microsoft Defender for IoT, before signing up, and incorporating it into their environment.

By using virtual environments, along with the software needed to create a sensor, Defender for IoT allows you to:

- Use passive, agentless network monitoring to gain a complete inventory of all your IoT, and OT devices, their details, and how they communicate, with zero effect on the IoT, and OT network.

- Identify risks and vulnerabilities in your IoT, and OT environment. For example, identify unpatched devices, open ports, unauthorized applications, and unauthorized connections. You can also identify changes to device configurations, PLC code, and firmware.

- Detect anomalous or unauthorized activities with specialized IoT, and OT-aware threat intelligence and behavioral analytics. You can even detect advanced threats missed by static IOCs, like zero-day malware, fileless malware, and living-off-the-land tactics.

- Integrate into Microsoft Sentinel for a bird's-eye view of your entire organization. Implement unified IoT, and OT security governance with integration into your existing workflows, including third-party tools like Splunk, IBM QRadar, and ServiceNow.

In this tutorial, you learn how to:

> [!div class="checklist"]
> * Onboard with Microsoft Defender for IoT
> * Download the ISO for the virtual sensor
> * Create a virtual machine for the sensor
> * Install the virtual sensor software
> * Configure a SPAN port
> * Onboard, and activate the virtual sensor

## Prerequisites

- Permissions: Azure **Subscription Owners**, or **Subscription Contributors** level.

- At least one device to monitor connected to a SPAN port on the switch.

- Either VMware (ESXi 5.5 or later), or Hyper-V hypervisor (Windows 10 Pro or Enterprise) is installed and operational.

- An Azure account. If you do not already have an Azure account, you can [create your Azure free account today](https://azure.microsoft.com/free/).

## Onboard with Microsoft Defender for IoT

To get started with Microsoft Defender for IoT, you must have a Microsoft Azure subscription. If you do not have a subscription, you can [create your Azure free account today](https://azure.microsoft.com/free/).

To evaluate Defender for IoT, you can use a trial subscription. The trial is valid for 30 days and supports up to 1000 committed devices. The trial allows you to deploy a virtual sensor on your network. Use the sensors to monitor traffic, analyze data, generate alerts, learn about network risks and vulnerabilities, and more. The trial also allows you to deploy a virtual on-premises management console to view the aggregated information generated by the sensor.

**To onboard a subscription to Microsoft Defender for IoT**:

1. Navigate to the [Azure portal](https://portal.azure.com/).

1. Search for, and select **Microsoft Defender for IoT**.

1. Select **Onboard subscription**.

    :::image type="content" source="media/tutorial-onboarding/onboard-subscription.png" alt-text="Screenshot of the selecting the onboard subscription button from the Getting started page.":::

1. On the Pricing page, select **Start with a trial**.

   :::image type="content" source="media/tutorial-onboarding/start-with-trial.png" alt-text="Screenshot of the start with a trial button to open the trial window.":::

1. Select a subscription from the Onboard trial subscription pane and then select **Evaluate**.

1. Confirm your evaluation.

## Download the ISO for the virtual sensor

The virtual appliances have minimum specifications that are required for both the sensor and management console. The following table shows the specifications needed for the sensor depending on your environment.

### Virtual sensor

| Type | Corporate | Enterprise | SMB |
|--|--|--|--|
| vCPU | 32 | 8 | 4 |
| Memory | 32 GB | 32 GB | 8 GB |
| Storage | 5.6 TB | 1.8 TB | 500 GB |

**To download the ISO file for the virtual sensor**:

1. Navigate to the [Azure portal](https://portal.azure.com/).

1. Search for, and select **Microsoft Defender for IoT**.

1. On the Getting started page, select the **Sensor** tab.

1. Select **Download**.

    :::image type="content" source="media/tutorial-onboarding/sensor-download.png" alt-text="Screenshot of the sensor tab, select download, to download the ISO file for the virtual sensor.":::

## Create a virtual machine for the sensor

The virtual sensor supports both VMware, and Hyper-V deployment options. Before you begin the installation, make sure you have the following items:

- VMware (ESXi 5.5 or later), or Hyper-V hypervisor (Windows 10 Pro or Enterprise) installed and operational.

- Available hardware resources for the virtual machine.

- ISO installation file for the Microsoft Defender for IoT sensor.

- Make sure the hypervisor is running.

### Create the virtual machine for the sensor with ESXi

**To create the virtual machine for the sensor (ESXi)**:

1. Sign in to the ESXi, choose the relevant **datastore**, and select **Datastore Browser**.

1. **Upload** the image and select **Close**.

1. Go to **Virtual Machines**, and then select **Create/Register VM**.

1. Select **Create new virtual machine**, and then select **Next**.

1. Add a sensor name and choose:

   - Compatibility: **&lt;latest ESXi version&gt;**

   - Guest OS family: **Linux**

   - Guest OS version: **Ubuntu Linux (64-bit)**

1. Select **Next**.

1. Choose the relevant datastore and select **Next**.

1. Change the virtual hardware parameters according to the required [architecture](#download-the-iso-for-the-virtual-sensor).

1. For **CD/DVD Drive 1**, select **Datastore ISO file** and choose the ISO file that you uploaded earlier.

1. Select **Next** > **Finish**.

1. Power on the VM, and open a console.

### Create a virtual machine for the sensor with Hyper-V

This procedure describes how to create a virtual machine by using Hyper-V.

**To create a virtual machine with Hyper-V**:

1. Create a virtual disk in Hyper-V Manager.

1. Select **format = VHDX**.

1. Select **type = Dynamic Expanding**.

1. Enter the name and location for the VHD.

1. Enter the required size (according to the [architecture](#download-the-iso-for-the-virtual-sensor)).

1. Review the summary and select **Finish**.

1. On the **Actions** menu, create a new virtual machine.

1. Enter a name for the virtual machine.

1. Select **Specify Generation** > **Generation 1**.

1. Specify the memory allocation (according to the [architecture](#download-the-iso-for-the-virtual-sensor)) and select the check box for dynamic memory.

1. Configure the network adaptor according to your server network topology.

1. Connect the VHDX created previously to the virtual machine.

1. Review the summary and select **Finish**.

1. Right-click the new virtual machine and select **Settings**.

1. Select **Add Hardware** and add a new network adapter.

1. Select the virtual switch that will connect to the sensor management network.

1. Allocate CPU resources (according to the [architecture](#download-the-iso-for-the-virtual-sensor)).

1. Connect the management console's ISO image to a virtual DVD drive.

1. Start the virtual machine.

1. On the **Actions** menu, select **Connect** to continue the software installation.

## Install the virtual sensor software with ESXi or Hyper-V

Either ESXi, or Hyper-V can be used to install the software for the virtual sensor.

**To install the software on the virtual sensor**:

1. Open the virtual machine console.

1. The VM will start from the ISO image, and the language selection screen will appear. Select **English**.

1. Select the required [architecture](#download-the-iso-for-the-virtual-sensor).

1. Define the appliance profile and network properties:

    | Parameter | Configuration |
    | ----------| ------------- |
    | **Hardware profile** | Based on the required [architecture](#download-the-iso-for-the-virtual-sensor). |
    | **Management interface** | **ens192** |
    | **Network parameters (provided by the customer)** | **management network IP address:** <br/>**subnet mask:** <br>**appliance hostname:** <br/>**DNS:** <br/>**default gateway:** <br/>**input interfaces:**|
    | **bridge interfaces:** | There's no need to configure the bridge interface. This option is for special use cases only. |

1. Enter **Y** to accept the settings.

1. Sign-in credentials are automatically generated and presented. Copy the username and password in a safe place, because they're required to sign-in, and manage your device. The username and password will not be presented again.

    - **Support**: The administrative user for user management.

    - **CyberX**: The equivalent of root for accessing the appliance.

1. The appliance restarts.

1. Access the sensor via the IP address previously configured: `https://ip_address`.

### Post-installation validation

To validate the installation of a physical appliance, you need to perform many tests.

The validation is available to both the **Support**, and **CyberX** user.

**To access the post validation tool**:

1. Sign in to the sensor.

1. Select **System Settings** from the left side pane.

1. Select the :::image type="icon" source="media/tutorial-onboarding/system-statistics-icon.png" border="false"::: button.

    :::image type="content" source="media/tutorial-onboarding/system-health-check-screen.png" alt-text="Screenshot of the system health check." lightbox="media/tutorial-onboarding/system-health-check-screen-expanded.png":::

For post-installation validation, you must test to ensure the system is running, that you have the right version, and to verify that all of the input interfaces that were configured during the installation process are running.

**To verify that the system is running**:

1. Select **Appliance**, and ensure that each line item shows `Running` and the bottom line states `System is up`.

1. Select **Version**, and ensure that the correct version appears.

1. Select **ifconfig** to display the parameters for the appliance's physical interfaces, and ensure that they are correct.

## Configure a SPAN port

A virtual switch does not have mirroring capabilities. However, you can use promiscuous mode in a virtual switch environment. Promiscuous mode  is a mode of operation, as well as a security, monitoring and administration technique, that is defined at the virtual switch, or portgroup level. By default, Promiscuous mode is disabled. When Promiscuous mode is enabled the virtual machine’s network interfaces that are in the same portgroup will use the Promiscuous mode to view all network traffic that goes through that virtual switch. You can implement a workaround with either ESXi, or Hyper-V.

:::image type="content" source="media/tutorial-onboarding/purdue-model.png" alt-text="A screenshot of where in your architecture the sensor should be placed.":::

### Configure a SPAN port with ESXi

**To configure a SPAN port with ESXi**:

1. Open vSwitch properties.

1. Select **Add**.

1. Select **Virtual Machine** > **Next**.

1. Insert a network label **SPAN Network**, select **VLAN ID** > **All**, and then select **Next**.

1. Select **Finish**.

1. Select **SPAN Network** > **Edit*.

1. Select **Security**, and verify that the **Promiscuous Mode** policy is set to **Accept** mode.

1. Select **OK**, and then select **Close** to close the vSwitch properties.

1. Open the **XSense VM** properties.

1. For **Network Adapter 2**, select the **SPAN** network.

1. Select **OK**.

1. Connect to the sensor, and verify that mirroring works.

### Configure a SPAN port with Hyper-V

Prior to starting you will need to:

- Ensure that there is no instance of a virtual appliance running.

- Enable Ensure SPAN on the data port, and not the management port.

- Ensure that the data port SPAN configuration is not configured with an IP address.

**To configure a SPAN port with Hyper-V**:

1. Open the Virtual Switch Manager.

1. In the Virtual Switches list, select **New virtual network switch** > **External** as the dedicated spanned network adapter type.

    :::image type="content" source="media/tutorial-onboarding/new-virtual-network.png" alt-text="Screenshot of selecting new virtual network and external before creating the virtual switch.":::

1. Select **Create Virtual Switch**.

1. Under connection type, select **External Network**.

1. Ensure the checkbox for **Allow management operating system to share this network adapter** is checked.

   :::image type="content" source="media/tutorial-onboarding/external-network.png" alt-text="Select external network, and allow the management operating system to share the network adapter.":::

1. Select **OK**.

#### Attach a SPAN Virtual Interface to the virtual switch

You are able to attach a SPAN Virtual Interface to the Virtual Switch through Windows PowerShell, or through Hyper-V Manager.

**To attach a SPAN Virtual Interface to the virtual switch with PowerShell**:

1. Select the newly added SPAN virtual switch, and add a new network adapter with the following command:

    ```bash
    ADD-VMNetworkAdapter -VMName VK-C1000V-LongRunning-650 -Name Monitor -SwitchName vSwitch_Span
    ```

1. Enable port mirroring for the selected interface as the span destination with the following command:

    ```bash
    Get-VMNetworkAdapter -VMName VK-C1000V-LongRunning-650 | ? Name -eq Monitor | Set-VMNetworkAdapter -PortMirroring Destination
    ```

    | Parameter | Description |
    |--|--|
    | VK-C1000V-LongRunning-650 | CPPM VA name |
    |vSwitch_Span |Newly added SPAN virtual switch name |
    |Monitor |Newly added adapter name |

1. Select **OK**.

These commands set the name of the newly added adapter hardware to be `Monitor`. If you are using Hyper-V Manager, the name of the newly added adapter hardware is set to `Network Adapter`.

**To attach a SPAN Virtual Interface to the virtual switch with Hyper-V Manager**:

1. Under the Hardware list, select **Network Adapter**.

1. In the Virtual Switch field, select **vSwitch_Span**.

    :::image type="content" source="media/tutorial-onboarding/vswitch-span.png" alt-text="Screenshot of selecting the following options on the virtual switch screen.":::

1. In the Hardware list, under the Network Adapter drop-down list, select **Advanced Features**.

1. In the Port Mirroring section, select **Destination** as the mirroring mode for the new virtual interface.

    :::image type="content" source="media/tutorial-onboarding/destination.png" alt-text="Screenshot of the selections needed to configure mirroring mode.":::

1. Select **OK**.

#### Enable Microsoft NDIS Capture Extensions for the Virtual Switch

Microsoft NDIS Capture Extensions will need to be enabled for the new virtual switch.

**To enable Microsoft NDIS Capture Extensions for the newly added virtual switch**:

1. Open the Virtual Switch Manager on the Hyper-V host.

1. In the Virtual Switches list, expand the virtual switch name `vSwitch_Span` and select **Extensions**.

1. In the Switch Extensions field, select **Microsoft NDIS Capture**.

    :::image type="content" source="media/tutorial-onboarding/microsoft-ndis.png" alt-text="Screenshot of enabling the Microsoft NDIS by selecting it from the switch extensions menu.":::

1. Select **OK**.

#### Set the Mirroring Mode on the external port

Mirroring mode will need to be set on the external port of the new virtual switch to be the source.

You will need to configure the Hyper-V virtual switch (vSwitch_Span) to forward any traffic that comes to the external source port, to the virtual network adapter that you configured as the destination.

Use the following PowerShell commands to set the external virtual switch port to source mirror mode:

```bash
$ExtPortFeature=Get-VMSystemSwitchExtensionPortFeature -FeatureName "Ethernet Switch Port Security Settings"
$ExtPortFeature.SettingData.MonitorMode=2
Add-VMSwitchExtensionPortFeature -ExternalPort -SwitchName vSwitch_Span -VMSwitchExtensionFeature $ExtPortFeature
```

| Parameter | Description |
|--|--|
| vSwitch_Span | Newly added SPAN virtual switch name. |
| MonitorMode=2 | Source |
| MonitorMode=1 | Destination |
| MonitorMode=0 | None |

Use the following PowerShell command to verify the monitoring mode status:

```bash
Get-VMSwitchExtensionPortFeature -FeatureName "Ethernet Switch Port Security Settings" -SwitchName vSwitch_Span -ExternalPort | select -ExpandProperty SettingData
```

| Parameter | Description |
|--|--|
| vSwitch_Span | Newly added SPAN virtual switch name |
## Onboard, and activate the virtual sensor

Before you can start using your Defender for IoT sensor, you will need to onboard the created virtual sensor to your Azure subscription, and download the virtual sensor's activation file to activate the sensor.

### Onboard the virtual sensor

**To onboard the virtual sensor:**

1. Go to [Defender for IoT: Getting started](https://portal.azure.com/#blade/Microsoft_Azure_IoT_Defender/IoTDefenderDashboard/Getting_Started) in the Azure portal.

1. Select **Onboard sensor**.

   :::image type="content" source="media/tutorial-onboarding/onboard-a-sensor.png" alt-text="Screenshot of selecting to onboard the sensor to start the onboarding process for your sensor.":::

1. Enter a name for the sensor.

   We recommend that you include the IP address of the sensor as part of the name, or use an easily identifiable name. Naming your sensor in this way will ensure easier tracking.

1. Select a subscription from the drop-down menu.

    :::image type="content" source="media/tutorial-onboarding/name-subscription.png" alt-text="Screenshot of entering a meaningful name, and connect your sensor to a subscription.":::

1. Choose a sensor connection mode by using the **Cloud connected** toggle. If the toggle is on, the sensor is cloud connected. If the toggle is off, the sensor is locally managed.

   - **Cloud-connected sensors**: Information that the sensor detects is displayed in the sensor console. Alert information is delivered through an IoT hub and can be shared with other Azure services, such as Microsoft Sentinel. In addition, threat intelligence packages can be pushed from Defender for IoT to sensors. Conversely when, the sensor is not cloud connected, you must download  threat intelligence packages and then upload them to your enterprise sensors. To allow Defender for IoT to push packages to sensors, enable the **Automatic Threat Intelligence Updates** toggle. For more information, see [Threat intelligence research and packages](how-to-work-with-threat-intelligence-packages.md).

      For cloud connected sensors, the name defined during onboarding is the name that appears in the sensor console. You can't change this name from the console directly. For locally managed sensors, the name applied during onboarding will be stored in Azure but can be updated in the sensor console.

   - **Locally managed sensors**: Information that sensors detect is displayed in the sensor console. If you're working in an air-gapped network and want a unified view of all information detected by multiple locally managed sensors, work with the on-premises management console.

1. Select a site to associate your sensor to within an IoT Hub. The IoT Hub will serve as a gateway between this sensor and Microsoft Defender for IoT. Define the display name, and zone. You can also add descriptive tags. The display name, zone, and tags are descriptive entries on the [View onboarded sensors](how-to-manage-sensors-on-the-cloud.md#view-onboarded-sensors).

1. Select **Register**.

### Download the sensor activation file

Once registration is complete for the sensor, you will be able to download an activation file for the sensor. The sensor activation file contains instructions about the management mode of the sensor. The activation file you download, will be unique for each sensor that you deploy. The user who signs in to the sensor console for the first time, will uploads the activation file to the sensor.

**To download an activation file:**

1. On the **Onboard Sensor** page, select **Register**

1. Select **download activation file**.

1. Make the file accessible to the user who's signing in to the sensor console for the first time.

### Sign in and activate the sensor

**To sign in and activate:**

1. Go to the sensor console from your browser by using the IP defined during the installation.

    :::image type="content" source="media/tutorial-onboarding/azure-defender-for-iot-sensor-log-in-screen.png" alt-text="Screenshot of the Microsoft Defender for IoT sensor.":::

1. Enter the credentials defined during the sensor installation.

1. After you sign in, the **Activation** dialog box opens. Select **Upload** and go to the activation file that you downloaded during the sensor onboarding.

   :::image type="content" source="media/tutorial-onboarding/activation-upload-screen-with-upload-button.png" alt-text="Screenshot of selecting to upload and go to the activation file.":::

1. Accept the terms and conditions.

1. Select **Activate**. The SSL/TLS certificate dialog box opens.

1. Define a certificate name.

1. Upload the CRT and key files.

1. Enter a passphrase and upload a PEM file if necessary.

1. Select **Next**. The validation screen opens. By default, validation between the management console and connected sensors is enabled.

1. Turn off the **Enable system-wide validation** toggle to disable validation. We recommend that you enable validation.

1. Select **Save**.  

You might need to refresh your screen after uploading the CA-signed certificate.

## Next steps

Learn how to set up [other appliances](how-to-install-software.md#about-defender-for-iot-appliances).

Read about the [agentless architecture](architecture.md).
